<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales TV (Screenshots + Celebrations)</title>

  <style>
    :root{
      --fade-ms: 320ms;
      --bg: #000;
      --text: #fff;
    }

    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    /* Slides */
    .slide {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;     /* change to cover if you want full bleed */
      background: var(--bg);
      opacity: 0;
      transition: opacity var(--fade-ms) linear;
      z-index: 1;              /* always below overlays */
    }
    .slide.show { opacity: 1; }

    /* Black fade between states (optional but looks clean) */
    #fade {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      transition: opacity var(--fade-ms) linear;
      z-index: 5000;
      pointer-events: none;
    }
    #fade.on { opacity: 1; }

    /* Celebration overlay (FULL SCREEN ALWAYS) */
    #celebration {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 999999;

      background-color: #000;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;

      color: var(--text);
      text-align: center;

      align-items: center;
      justify-content: center;
      flex-direction: column;

      padding: 60px 8vw;
      box-sizing: border-box;
    }

    #celebration .card {
      width: min(1400px, 92vw);
      backdrop-filter: blur(6px);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 22px;
      padding: 28px 34px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
    }

    #celebration h1 {
      font-size: clamp(48px, 6vw, 82px);
      margin: 0;
      text-shadow: 0 0 18px rgba(0,0,0,0.85);
      letter-spacing: 0.5px;
    }

    #celebration p {
      font-size: clamp(22px, 2.7vw, 36px);
      margin: 16px 0 0;
      line-height: 1.25;
      white-space: pre-wrap;
      text-shadow: 0 0 14px rgba(0,0,0,0.85);
    }

    /* Tiny ‚Äústatus‚Äù badge (optional, helpful) */
    #statusBadge {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 6000;
      color: rgba(255,255,255,0.85);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 8px 12px;
      font: 13px/1.2 monospace;
      user-select: none;
    }

    /* Debug panel (set SHOW_DEBUG to true in JS) */
    #dbg {
      position: fixed;
      left: 14px;
      bottom: 14px;
      z-index: 1000000;
      color: #0f0;
      background: rgba(0,0,0,.65);
      font: 13px/1.35 monospace;
      padding: 10px 12px;
      border-radius: 12px;
      max-width: min(900px, 92vw);
      white-space: pre-wrap;
      display: none;
    }
    #dbg button{
      margin-top: 8px;
      font: 13px monospace;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
  <!-- Slides -->
  <img id="slideA" class="slide show" alt="slide A" />
  <img id="slideB" class="slide" alt="slide B" />

  <!-- Optional fade layer -->
  <div id="fade"></div>

  <!-- Small status badge -->
  <div id="statusBadge">Sales TV</div>

  <!-- Celebration overlay -->
  <div id="celebration">
    <div class="card">
      <h1 id="celeTitle">üéâ CELEBRATION üéâ</h1>
      <p id="celeMsg"></p>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="sound-idv" preload="auto">
    <source src="https://actions.google.com/sounds/v1/cash_register/cash_register_open.ogg" type="audio/ogg">
  </audio>
  <audio id="sound-tbk" preload="auto">
    <source src="https://actions.google.com/sounds/v1/crowd/crowd_cheer.ogg" type="audio/ogg">
  </audio>

  <!-- Debug (hidden by default) -->
  <div id="dbg">
    <div id="dbgText">debug</div>
    <button id="btnTest">TEST CELEBRATION</button>
    <button id="btnHide">HIDE</button>
  </div>

  <script>
    /******************** CONFIG ********************/
    const SLIDE_MS = 2 * 60 * 1000;      // ‚úÖ switch every 2 minutes
    const POLL_MS  = 2000;               // celebration poll
    const SHOW_DEBUG = false;            // set true while testing

    // ‚úÖ Your working Apps Script web app URL:
    const triggerUrl = "https://script.google.com/macros/s/AKfycbwPFEP8tWC85Xo5RVvjwNvMXSI-W6iqcIvnCfKIpJrehVX-X6jEfaqDkFR_dWTB_ApduA/exec";

    /******************** DOM ********************/
    const slideA = document.getElementById("slideA");
    const slideB = document.getElementById("slideB");
    const fadeEl = document.getElementById("fade");
    const badge  = document.getElementById("statusBadge");

    const celebrationEl = document.getElementById("celebration");
    const titleEl = document.getElementById("celeTitle");
    const msgEl   = document.getElementById("celeMsg");

    const dbgEl   = document.getElementById("dbg");
    const dbgText = document.getElementById("dbgText");
    if (SHOW_DEBUG) dbgEl.style.display = "block";

    function setDbg(t){
      if (!SHOW_DEBUG) return;
      dbgText.textContent = t;
    }

    /******************** SLIDESHOW ********************/
    let slides = [];
    let idx = 0;
    let activeIsA = true;
    let timer = null;

    function active() { return activeIsA ? slideA : slideB; }
    function hidden() { return activeIsA ? slideB : slideA; }

    function setImgAndWait(img, file) {
      return new Promise((resolve, reject) => {
        img.onload = () => resolve(true);
        img.onerror = () => reject(new Error("image load failed: " + file));
        img.src = file + "?cb=" + Date.now(); // cache-bust to always use newest screenshots
      });
    }

    function swapVisible() {
      activeIsA = !activeIsA;
      slideA.classList.toggle("show", activeIsA);
      slideB.classList.toggle("show", !activeIsA);
    }

    async function loadManifest() {
      const res = await fetch("shots/manifest.json?cb=" + Date.now());
      if (!res.ok) throw new Error("Cannot load shots/manifest.json (HTTP " + res.status + ")");
      const data = await res.json();
      if (!Array.isArray(data) || !data.length) throw new Error("Manifest is empty");
      return data;
    }

    async function preloadNext() {
      const next = (idx + 1) % slides.length;
      await setImgAndWait(hidden(), slides[next].file);
    }

    async function nextSlide() {
      // Pause slideshow while celebration is visible
      if (isCelebrationVisible()) {
        timer = setTimeout(nextSlide, 1000);
        return;
      }

      try {
        // Fade to black very briefly (cleaner transition)
        fadeEl.classList.add("on");
        await preloadNext();
        idx = (idx + 1) % slides.length;
        swapVisible();
        // Fade back in
        setTimeout(() => fadeEl.classList.remove("on"), 80);
      } catch (e) {
        console.log(e);
        setDbg("slide err: " + String(e));
        // Retry soon instead of flashing
        setTimeout(() => fadeEl.classList.remove("on"), 80);
        timer = setTimeout(nextSlide, 2000);
        return;
      }

      timer = setTimeout(nextSlide, SLIDE_MS);
    }

    (async () => {
      try {
        slides = await loadManifest();
        idx = 0;
        await setImgAndWait(slideA, slides[0].file);
        // Preload next early for instant first switch
        if (slides.length > 1) await setImgAndWait(slideB, slides[1].file);
        timer = setTimeout(nextSlide, SLIDE_MS);
        badge.textContent = "Sales TV ‚Ä¢ running";
      } catch (e) {
        badge.textContent = "Sales TV ‚Ä¢ ERROR";
        setDbg("boot err:\n" + String(e));
      }
    })();

    /******************** CELEBRATIONS ********************/
    const CELEBRATIONS = {
      IDV: {
        title: "üéâ NEW IDV üéâ",
        gif: "https://media.giphy.com/media/Is1O1TWV0LEJi/giphy.gif",
        sound: document.getElementById("sound-idv")
      },
      TBK: {
        title: "üèÜ NEW TBK üèÜ",
        gif: "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
        sound: document.getElementById("sound-tbk")
      }
    };

    let overlayVisible = false;
    let currentCelebrationKey = null;

    function isCelebrationVisible() {
      return celebrationEl.style.display === "flex";
    }

    function showOverlay(kindKey, message) {
      const cfg = CELEBRATIONS[kindKey];
      if (!cfg) return;

      // Make overlay full-screen and on top
      if (currentCelebrationKey !== kindKey) {
        titleEl.textContent = cfg.title;
        celebrationEl.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url("${cfg.gif}")`;
        currentCelebrationKey = kindKey;
      }
      msgEl.textContent = message || "";

      // Fade to black underlay for a clean cut
      fadeEl.classList.add("on");

      if (!overlayVisible && cfg.sound) {
        try {
          cfg.sound.currentTime = 0;
          cfg.sound.play();
        } catch (e) {
          // Autoplay may be blocked until first keypress (Fire TV)
        }
      }

      celebrationEl.style.display = "flex";
      overlayVisible = true;
      badge.textContent = "Sales TV ‚Ä¢ CELEBRATION";
    }

    function hideOverlay() {
      celebrationEl.style.display = "none";
      msgEl.textContent = "";
      overlayVisible = false;
      currentCelebrationKey = null;
      fadeEl.classList.remove("on");
      badge.textContent = "Sales TV ‚Ä¢ running";
    }

    function normUpper(v){ return (v ?? "").toString().trim().toUpperCase(); }
    function norm(v){ return (v ?? "").toString().trim(); }

    async function poll() {
      const url = triggerUrl + (triggerUrl.includes("?") ? "&" : "?") + "cb=" + Date.now();
      try {
        const res = await fetch(url, { cache: "no-store", credentials: "omit", redirect: "follow" });
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const text = await res.text();

        setDbg(
          "poll " + new Date().toLocaleTimeString() + "\n" +
          "http " + res.status + "\n" +
          "ct " + ct + "\n" +
          "body " + text.slice(0, 160)
        );

        if (!ct.includes("application/json")) return;

        const data = JSON.parse(text);
        const status = normUpper(data.status);
        const message = norm(data.message);

        if (CELEBRATIONS[status]) showOverlay(status, message);
        else if (overlayVisible) hideOverlay();

      } catch (e) {
        setDbg("poll error:\n" + String(e));
      }
    }

    poll();
    setInterval(poll, POLL_MS);

    /******************** AUDIO UNLOCK (Fire TV) ********************/
    function unlockAudio() {
      const sounds = document.querySelectorAll("audio");
      sounds.forEach(a => {
        const prevVol = a.volume;
        a.volume = 0;
        a.play().then(() => {
          a.pause();
          a.currentTime = 0;
          a.volume = prevVol;
        }).catch(() => {});
      });
      window.removeEventListener("keydown", unlockAudio);
      window.removeEventListener("pointerdown", unlockAudio);
    }
    window.addEventListener("keydown", unlockAudio, { once: true });
    window.addEventListener("pointerdown", unlockAudio, { once: true });

    /******************** DEBUG BUTTONS ********************/
    document.getElementById("btnTest").onclick = () => showOverlay("IDV", "Test overlay works ‚úÖ");
    document.getElementById("btnHide").onclick = () => hideOverlay();
  </script>
</body>
</html>
