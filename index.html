<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales TV (Screenshots + Celebrations)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }

    img {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      opacity: 0;
      transition: opacity 250ms linear;
    }
    img.show { opacity: 1; }

    /* Celebration overlay */
    #celebration {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      color: #fff;
      text-align: center;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 60px 8vw;
      box-sizing: border-box;
    }
    #celebration h1 {
      font-size: 72px;
      margin: 0;
      text-shadow: 0 0 20px rgba(0,0,0,0.8);
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
    }
    #celebration p {
      font-size: 32px;
      margin-top: 18px;
      max-width: 1400px;
      line-height: 1.3;
      white-space: pre-wrap;
      text-shadow: 0 0 15px rgba(0,0,0,0.8);
      margin-left: auto;
      margin-right: auto;
    }

    /* Debug overlay (visible) */
    #dbg {
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 10001;
      color: #0f0;
      background: rgba(0,0,0,.6);
      font: 14px/1.3 monospace;
      padding: 10px 12px;
      border-radius: 10px;
      max-width: 60vw;
      white-space: pre-wrap;
    }
    #dbg button {
      margin-top: 8px;
      font: 14px monospace;
      padding: 6px 10px;
    }
  </style>
</head>
<body>
  <!-- Slideshow images -->
  <img id="a" class="show" />
  <img id="b" />

  <!-- Celebration Overlay -->
  <div id="celebration">
    <h1 id="celeTitle">ðŸŽ‰ CELEBRATION ðŸŽ‰</h1>
    <p id="msg"></p>
  </div>

  <!-- Sounds -->
  <audio id="sound-idv" preload="auto">
    <source src="https://actions.google.com/sounds/v1/cash_register/cash_register_open.ogg" type="audio/ogg">
  </audio>
  <audio id="sound-tbk" preload="auto">
    <source src="https://actions.google.com/sounds/v1/crowd/crowd_cheer.ogg" type="audio/ogg">
  </audio>

  <!-- Debug -->
  <div id="dbg">
    bootingâ€¦
    <div>
      <button id="testBtn">TEST CELEBRATION</button>
      <button id="hideBtn">HIDE</button>
    </div>
  </div>

  <script>
    /******************** SETTINGS ********************/
    const SLIDE_MS = 2 * 60 * 1000;     // 2 minutes
    const POLL_MS  = 2000;

    // âœ… Put your exact working URL here (the one that returns JSON on your laptop)
    const triggerUrl = "https://script.google.com/macros/s/AKfycbwPFEP8tWC85Xo5RVvjwNvMXSI-W6iqcIvnCfKIpJrehVX-X6jEfaqDkFR_dWTB_ApduA/exec";

    /******************** HELPERS ********************/
    const dbg = document.getElementById("dbg");
    function setDbg(t){ dbg.firstChild.textContent = t; }

    function normUpper(v){ return (v ?? "").toString().trim().toUpperCase(); }
    function norm(v){ return (v ?? "").toString().trim(); }

    /******************** SLIDESHOW ********************/
    const a = document.getElementById("a");
    const b = document.getElementById("b");
    let slides = [];
    let idx = 0;
    let activeIsA = true;

    function hidden(){ return activeIsA ? b : a; }
    function swapVisible(){
      activeIsA = !activeIsA;
      a.classList.toggle("show", activeIsA);
      b.classList.toggle("show", !activeIsA);
    }

    async function loadManifest(){
      const res = await fetch("shots/manifest.json?cb=" + Date.now());
      if (!res.ok) throw new Error("manifest HTTP " + res.status);
      return res.json();
    }

    function setImgAndWait(img, file){
      return new Promise((resolve, reject) => {
        img.onload = () => resolve(true);
        img.onerror = () => reject(new Error("image load failed: " + file));
        img.src = file + "?cb=" + Date.now();
      });
    }

    async function preloadNext(){
      const next = (idx + 1) % slides.length;
      await setImgAndWait(hidden(), slides[next].file);
    }

    async function nextSlide(){
      if (isCelebrationVisible()) { setTimeout(nextSlide, 1000); return; }
      try {
        await preloadNext();
        idx = (idx + 1) % slides.length;
        swapVisible();
      } catch(e) {
        console.log(e);
      }
      setTimeout(nextSlide, SLIDE_MS);
    }

    (async () => {
      try {
        slides = await loadManifest();
        await setImgAndWait(a, slides[0].file);
        setTimeout(nextSlide, SLIDE_MS);
      } catch (e) {
        setDbg("slideshow error:\n" + String(e));
      }
    })();

    /******************** CELEBRATIONS ********************/
    const CELEBRATIONS = {
      IDV: {
        title: "ðŸŽ‰ NEW IDV ðŸŽ‰",
        gif: "https://media.giphy.com/media/Is1O1TWV0LEJi/giphy.gif",
        sound: document.getElementById("sound-idv")
      },
      TBK: {
        title: "ðŸ† NEW TBK ðŸ†",
        gif: "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
        sound: document.getElementById("sound-tbk")
      }
    };

    const celebrationEl = document.getElementById("celebration");
    const titleEl = document.getElementById("celeTitle");
    const msgEl = document.getElementById("msg");

    let overlayVisible = false;
    let currentCelebrationKey = null;

    function showOverlay(kindKey, message){
      const cfg = CELEBRATIONS[kindKey];
      if (!cfg) return;

      if (currentCelebrationKey !== kindKey) {
        titleEl.textContent = cfg.title;
        celebrationEl.style.backgroundImage =
          `linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url("${cfg.gif}")`;
        currentCelebrationKey = kindKey;
      }
      msgEl.innerText = message || "";

      if (!overlayVisible && cfg.sound) {
        try {
          cfg.sound.currentTime = 0;
          cfg.sound.play();
        } catch (e) {
          // sound may be blocked until first keypress; overlay should still show
        }
      }

      celebrationEl.style.display = "flex";
      overlayVisible = true;
    }

    function hideOverlay(){
      celebrationEl.style.display = "none";
      msgEl.innerText = "";
      overlayVisible = false;
      currentCelebrationKey = null;
    }

    function isCelebrationVisible(){
      return celebrationEl.style.display === "flex";
    }

    // Buttons for testing
    document.getElementById("testBtn").onclick = () => showOverlay("IDV", "Test overlay works âœ…");
    document.getElementById("hideBtn").onclick = () => hideOverlay();

    async function poll() {
  const url = triggerUrl + (triggerUrl.includes("?") ? "&" : "?") + "cb=" + Date.now();
  try {
    const res = await fetch(url, {
      cache: "no-store",
      redirect: "follow",
      credentials: "omit",
      mode: "cors"
    });

    const finalUrl = res.url || "(no url)";
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const text = await res.text();

    setDbg(
      "poll " + new Date().toLocaleTimeString() + "\n" +
      "http " + res.status + "\n" +
      "final " + finalUrl + "\n" +
      "ct " + ct + "\n" +
      "body " + text.slice(0, 140)
    );

    if (!ct.includes("application/json")) return;

    const data = JSON.parse(text);
    const status = normUpper(data.status);
    const message = norm(data.message);

    if (CELEBRATIONS[status]) showOverlay(status, message);
    else if (overlayVisible) hideOverlay();

  } catch (e) {
    setDbg("poll error:\n" + String(e));
  }
}


    poll();
    setInterval(poll, POLL_MS);
  </script>
</body>
</html>


