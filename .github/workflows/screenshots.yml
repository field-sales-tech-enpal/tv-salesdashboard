name: Update Looker screenshots

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

# Only one run at a time. If a new run is triggered while one is in progress,
# cancel the old one — there's no value in queuing stale screenshot jobs.
concurrency:
  group: looker-screenshots
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  shots:
    runs-on: ubuntu-latest
    timeout-minutes: 8 # hard ceiling well under the 10-min cron interval

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Full history so rebases never fail due to shallow clone limits.
          # persist-credentials is true by default with GITHUB_TOKEN — explicit for clarity.
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm" # caches ~/.npm between runs

      # Cache Playwright browser binaries. Key includes the lockfile hash so a
      # deps upgrade automatically busts the cache.
      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: playwright-${{ runner.os }}-

      - name: Install deps
        run: npm ci

      # Skip OS deps on ubuntu-latest (they're pre-installed). If you ever see
      # "Host system is missing dependencies" errors, add --with-deps back.
      - name: Install Playwright Chromium
        run: npx playwright install chromium
        # Only re-download if the cache missed
        if: steps.pw-cache.outputs.cache-hit != 'true'

      # Ensure we're working from the absolute latest main before writing files.
      # Using reset --hard avoids any merge commit noise.
      - name: Sync to latest main
        run: |
          git fetch origin main --quiet
          git checkout main
          git reset --hard origin/main

      - name: Take screenshots
        run: npm run shots

      - name: Write last-updated marker
        run: date -u +"%Y-%m-%dT%H:%M:%SZ" > shots/last-updated.txt

      - name: Commit & push
        env:
          BRANCH: main
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add shots

          # Nothing changed (Looker dashboards identical) — exit cleanly.
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update Looker screenshots [skip ci]"

          # Retry loop: handles the race where another run (or a human) pushed
          # to main between our reset and now.
          for attempt in 1 2 3 4 5; do
            if git push origin "HEAD:${BRANCH}"; then
              echo "Push succeeded on attempt ${attempt}."
              exit 0
            fi

            echo "Push failed (attempt ${attempt}/5). Fetching and rebasing..."
            git fetch origin "${BRANCH}" --quiet

            # If rebase fails (genuine conflict), abort cleanly rather than
            # leaving the repo in a broken state.
            if ! git rebase "origin/${BRANCH}"; then
              git rebase --abort
              echo "Rebase conflict — giving up."
              exit 1
            fi

            sleep $((attempt * 2)) # back off: 2s, 4s, 6s, 8s
          done

          echo "Push failed after 5 attempts."
          exit 1
